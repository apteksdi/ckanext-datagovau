server
{
    listen	80;
    server_name data.gov.au www.data.gov.au;
    root /var/www/sites/ckan_prod; ## <-- Your only path reference.

    error_log  /var/log/nginx/ckan_prodbatch_error.log;
    access_log /var/log/nginx/ckan_prodbatch_access.log  main;

    # Enable compression, this will help if you have for instance advaggâ€Ž module
    # by serving Gzip versions of the files.
    gzip  on;
    gzip_vary on;
    gzip_min_length 10240;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml;
    gzip_disable "MSIE [1-6]\.";

    server_tokens off;
    client_max_body_size 9999M;

    # [SXTPDFINXZCB-153] redirect as 'Use Cases' now uses showcase
    # instead of related datasets
    rewrite ^/related(.*)$ /showcase$1 permanent;

    # [SXTPDFINXZCB-189] an uncached stats page request takes several
    # minutes to complete
    proxy_read_timeout 600s;

    # [SXTPDFINXZCB-191] block certain bots that have been known to cause
    # site issues with excessive queries
    if ($http_user_agent ~* (baidu|yandex) ) {
        return 403;
    }

    # Pass geoserver requests back to the load balancer
    location ~ ^/geoserver
    {
        rewrite ^/geoserver(.*) /geoserver$1 break;
        proxy_pass http://prodgeoserver.dga.links.com.au:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, PUT, POST, DELETE';
        add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept';
    }

    location ~ ^/api
    {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, PUT, POST, DELETE';
        add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept, Authorization, X-CKAN-API-Key';
    }

    location ~ ^/
    {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location = /favicon.ico
    {
        log_not_found off;
        access_log off;
    }

    location = /robots.txt
    {
        allow all;
        log_not_found off;
        access_log off;
    }

    # Very rarely should these ever be accessed outside of your lan
    location ~* \.(txt|log)$
    {
        allow 172.31.0.0/16;
        deny all;
    }

    location ~* ^/sites/default/files/.*php
    {
        return 403;
    }

    location ~ \..*/.*\.php$
    {
        return 403;
    }

    # No no for private
    location ~ ^/sites/.*/private/
    {
        return 403;
    }

    # Block access to "hidden" files and directories whose names begin with a
    # period. This includes directories used by version control systems such
    # as Subversion or Git to store control files.
    location ~ (^|/)\.
    {
        return 403;
    }

    #location /
    #{
    #    client_max_body_size 32M;
         # This is cool because no php is touched for static content
    #    try_files $uri @rewrite;
    #}

    location @rewrite
    {
        # Clean URLs are handled in drupal_environment_initialize().
        rewrite ^ /index.php;
    }

    location ~ \.php$
    {
            # error 418 used to rewrite php file URIs from migrated sites.
        error_page 418 = @rewrite;
        recursive_error_pages on;

        fastcgi_split_path_info ^[^=](.+\.php)(/.+)$;
        include fastcgi_params;

        if ( $uri = /index.php )
        {
            break;
        }

        if (!-e $document_root$fastcgi_script_name)
        {
            return 418;
        }

        fastcgi_param SCRIPT_FILENAME $request_filename;
        fastcgi_param PHP_VALUE "upload_max_filesize=32M \n post_max_size=32M";
        fastcgi_intercept_errors on;
        fastcgi_pass unix:/tmp/phpfpm.sock;
        fastcgi_read_timeout 300;
    }

    # Fighting with Styles? This little gem is amazing.
    # This is for D6
    # This is for D7 and D8
    location ~ ^/sites/.*/files/styles/
    {
        try_files $uri @rewrite;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico)$
    {
        expires max;
        log_not_found off;
    }

    # auth_basic "Please enter your ckan_prod credentials to proceed.";
    # auth_basic_user_file /var/www/.passwords;

}